apiVersion: apps/v1
kind: Deployment
metadata:
  name: agentic-operator
  labels:
    app: agentic-operator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: agentic-operator
  template:
    metadata:
      labels:
        app: agentic-operator
    spec:
      serviceAccountName: agentic-operator
      containers:
      - name: agentic-operator
        image: quay.io/ambient_code/vteam_operator:latest
        imagePullPolicy: Always
        args:
        # Controller-runtime configuration
        - --max-concurrent-reconciles=10  # Process up to 10 sessions in parallel
        - --health-probe-bind-address=:8081
        - --leader-elect=false  # Enable for HA deployments with replicas > 1
        # Uncomment for debugging with legacy watch-based implementation:
        # - --legacy-watch
        ports:
        - containerPort: 8081
          name: health
          protocol: TCP
        env:
        # Controller concurrency (can be overridden via args)
        - name: MAX_CONCURRENT_RECONCILES
          value: "10"
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: BACKEND_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: BACKEND_API_URL
          value: "http://backend-service:8080/api"
        - name: AMBIENT_CODE_RUNNER_IMAGE
          value: "quay.io/ambient_code/vteam_claude_runner:latest"
        - name: CONTENT_SERVICE_IMAGE
          value: "quay.io/ambient_code/vteam_backend:latest"
        - name: IMAGE_PULL_POLICY
          value: "IfNotPresent"
        # Vertex AI configuration from ConfigMap
        - name: CLAUDE_CODE_USE_VERTEX
          valueFrom:
            configMapKeyRef:
              name: operator-config
              key: CLAUDE_CODE_USE_VERTEX
        - name: CLOUD_ML_REGION
          valueFrom:
            configMapKeyRef:
              name: operator-config
              key: CLOUD_ML_REGION
        - name: ANTHROPIC_VERTEX_PROJECT_ID
          valueFrom:
            configMapKeyRef:
              name: operator-config
              key: ANTHROPIC_VERTEX_PROJECT_ID
        - name: GOOGLE_APPLICATION_CREDENTIALS
          valueFrom:
            configMapKeyRef:
              name: operator-config
              key: GOOGLE_APPLICATION_CREDENTIALS
        # Platform-wide Langfuse observability configuration
        # All LANGFUSE_* config stored in ambient-admin-langfuse-secret (platform-admin managed)
        - name: LANGFUSE_ENABLED
          valueFrom:
            secretKeyRef:
              name: ambient-admin-langfuse-secret
              key: LANGFUSE_ENABLED
              optional: true  # Optional: defaults to false if secret doesn't exist
        - name: LANGFUSE_HOST
          valueFrom:
            secretKeyRef:
              name: ambient-admin-langfuse-secret
              key: LANGFUSE_HOST
              optional: true  # Optional: only needed if Langfuse enabled
        - name: LANGFUSE_PUBLIC_KEY
          valueFrom:
            secretKeyRef:
              name: ambient-admin-langfuse-secret
              key: LANGFUSE_PUBLIC_KEY
              optional: true  # Optional: only needed if Langfuse enabled
        - name: LANGFUSE_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: ambient-admin-langfuse-secret
              key: LANGFUSE_SECRET_KEY
              optional: true  # Optional: only needed if Langfuse enabled
        # Google OAuth client credentials for workspace-mcp
        - name: GOOGLE_OAUTH_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: google-workflow-app-secret
              key: GOOGLE_OAUTH_CLIENT_ID
              optional: true
        - name: GOOGLE_OAUTH_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: google-workflow-app-secret
              key: GOOGLE_OAUTH_CLIENT_SECRET
              optional: true
        # S3 state sync configuration (defaults - can be overridden per-project in settings)
        - name: STATE_SYNC_IMAGE
          value: "quay.io/ambient_code/vteam_state_sync:latest"
        - name: S3_ENDPOINT
          value: "http://minio.ambient-code.svc:9000"  # In-cluster MinIO (change for external S3)
        - name: S3_BUCKET
          value: "ambient-sessions"  # Create this bucket in MinIO console
        # OpenTelemetry configuration
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "otel-collector.ambient-code.svc:4317"  # Deploy OTel collector separately
        - name: DEPLOYMENT_ENV
          value: "production"
        - name: VERSION
          value: "latest"  # Override with actual version in production
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi
        livenessProbe:
          httpGet:
            path: /healthz
            port: health
          initialDelaySeconds: 15
          periodSeconds: 20
        readinessProbe:
          httpGet:
            path: /readyz
            port: health
          initialDelaySeconds: 5
          periodSeconds: 10
      restartPolicy: Always
