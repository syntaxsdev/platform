name: Test AGENTS.md Symlink

on:
  pull_request:
    paths:
      - 'AGENTS.md'
      - 'CLAUDE.md'
      - 'tests/test_agents_md_symlink.sh'
      - '.github/workflows/test-agents-md-symlink.yml'
  push:
    branches:
      - main
    paths:
      - 'AGENTS.md'
      - 'CLAUDE.md'
      - 'tests/test_agents_md_symlink.sh'

jobs:
  test-symlink:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Validate AGENTS.md symlink
      run: |
        chmod +x tests/test_agents_md_symlink.sh
        ./tests/test_agents_md_symlink.sh

    - name: Test cross-platform compatibility
      run: |
        echo "Testing symlink on Linux..."

        # Verify symlink properties
        ls -la AGENTS.md

        # Verify git stores it correctly
        git ls-files -s AGENTS.md

        # Verify content is accessible
        head -n 5 AGENTS.md

        echo "✅ Symlink works correctly on Linux"

    - name: Validate git tracking
      run: |
        # Check that AGENTS.md is in git index
        if git ls-files --error-unmatch AGENTS.md > /dev/null 2>&1; then
          echo "✅ AGENTS.md is tracked by git"
        else
          echo "❌ ERROR: AGENTS.md is not tracked by git"
          exit 1
        fi

        # Check that it's stored as a symlink in git
        MODE=$(git ls-files -s AGENTS.md | awk '{print $1}')
        if [ "$MODE" = "120000" ]; then
          echo "✅ AGENTS.md is stored as symlink (mode 120000)"
        else
          echo "❌ ERROR: AGENTS.md is not stored as symlink (mode: $MODE)"
          exit 1
        fi
